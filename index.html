<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>An√°lise de Investimentos com IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50 flex items-center justify-center">
  <div class="max-w-5xl w-full px-4 py-8">
    <!-- CARD PRINCIPAL -->
    <div class="bg-gradient-to-b from-violet-700/80 via-violet-900/80 to-slate-950 rounded-3xl p-6 md:p-8 shadow-[0_0_40px_rgba(0,0,0,0.6)] border border-violet-500/40">
      <div class="text-center mb-6">
        <h1 class="text-2xl md:text-3xl font-bold mb-1 flex items-center justify-center gap-2">
          <span class="text-emerald-300 text-xl">üìà</span>
          <span>An√°lise de Investimentos</span>
        </h1>
        <p class="text-xs md:text-sm text-slate-200">
          Tire uma foto do gr√°fico e receba recomenda√ß√£o instant√¢nea da IA.
        </p>
      </div>

      <!-- PREVIEW -->
      <div class="bg-slate-950/70 rounded-3xl border border-slate-800 p-3 mb-4">
        <div
          id="preview-container"
          class="rounded-2xl overflow-hidden border border-slate-800 bg-slate-900/80 h-52 flex items-center justify-center"
        >
          <p id="preview-placeholder" class="text-xs text-slate-500 text-center px-4">
            Nenhuma imagem selecionada.<br />
            Envie um print do gr√°fico para visualizar aqui.
          </p>
          <img
            id="preview-image"
            src=""
            alt="Preview do gr√°fico"
            class="hidden w-full h-full object-cover"
          />
        </div>
      </div>

      <!-- CONTROLES -->
      <div class="flex flex-col md:flex-row items-center gap-3 mb-4">
        <label class="w-full md:w-auto cursor-pointer">
          <input id="file-input" type="file" accept="image/*" class="hidden" />
          <span
            class="inline-flex items-center justify-center w-full md:w-auto px-5 py-3 rounded-full bg-slate-900 border border-slate-600 text-xs md:text-sm font-medium hover:border-slate-400"
          >
            Trocar Imagem
          </span>
        </label>

        <button
          id="analisar-btn"
          class="w-full md:w-auto px-6 py-3 rounded-full text-xs md:text-sm font-semibold bg-gradient-to-r from-fuchsia-500 to-violet-500 hover:from-fuchsia-400 hover:to-violet-400 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Analisar Gr√°fico
        </button>

        <span id="status-text" class="text-[11px] text-slate-300 md:ml-auto">
          Aguardando imagem...
        </span>
      </div>
    </div>

    <!-- RESULTADO -->
    <div
      id="resultado-card"
      class="mt-6 bg-gradient-to-r from-rose-900/80 via-rose-800/80 to-amber-900/80 rounded-3xl p-5 md:p-6 border border-rose-500/40 shadow-[0_0_40px_rgba(0,0,0,0.6)] hidden"
    >
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-semibold text-slate-200 uppercase tracking-wide">
          Resposta da IA
        </span>
        <span id="conf-text" class="text-[11px] text-slate-200">
          Confian√ßa: 70%
        </span>
      </div>

      <div class="text-3xl md:text-4xl font-black mb-2" id="acao-text">
        VENDER
      </div>

      <p class="text-xs md:text-sm text-slate-100" id="justificativa-text">
        A IA analisa tend√™ncia, topos e fundos, zonas de suporte e resist√™ncia
        para sugerir a melhor decis√£o.
      </p>
    </div>
  </div>

  <script>
  const fileInput = document.getElementById("file-input");
  const previewImage = document.getElementById("preview-image");
  const previewPlaceholder = document.getElementById("preview-placeholder");
  const analisarBtn = document.getElementById("analisar-btn");
  const statusText = document.getElementById("status-text");

  const resultadoCard = document.getElementById("resultado-card");
  const acaoText = document.getElementById("acao-text");
  const confText = document.getElementById("conf-text");
  const justificativaText = document.getElementById("justificativa-text");

  let selectedFile = null;

  // fun√ß√£o √∫nica pra setar a imagem (input OU cola)
  function setImageFile(file) {
    if (!file) return;

    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (ev) => {
      previewImage.src = ev.target.result;
      previewImage.classList.remove("hidden");
      previewPlaceholder.classList.add("hidden");
    };
    reader.readAsDataURL(file);
    statusText.textContent = "Imagem carregada. Pronto para analisar.";
  }

  // abrir seletor quando clicar no bot√£o "Trocar imagem"
  document.querySelector("label").addEventListener("click", () => {
    fileInput.click();
  });

  // quando escolher pelo gerenciador de arquivos
  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    setImageFile(file);
  });

  // üí• NOVO: permitir colar print (Ctrl+V)
  document.addEventListener("paste", (e) => {
    const items = e.clipboardData && e.clipboardData.items;
    if (!items) return;

    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (item.type.indexOf("image") !== -1) {
        const file = item.getAsFile();
        setImageFile(file);
        statusText.textContent = "Imagem colada da √°rea de transfer√™ncia. Pronto para analisar.";
        e.preventDefault();
        break;
      }
    }
  });

  // bot√£o Analisar
  analisarBtn.addEventListener("click", async () => {
    if (!selectedFile) {
      alert("Selecione ou cole primeiro o print do gr√°fico.");
      return;
    }

    analisarBtn.disabled = true;
    statusText.textContent = "Analisando gr√°fico com IA...";
    resultadoCard.classList.add("hidden");

    const formData = new FormData();
    formData.append("image", selectedFile);

    try {
      const res = await fetch("https://ia-analise-grafico.onrender.com", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        const text = await res.text();
        console.error("Resposta do backend n√£o OK:", res.status, text);
        throw new Error("Resposta n√£o OK do backend");
      }

      const data = await res.json();

      const acao = data.acao || "NAO_OPERAR";
      const conf = data.confianca || 0.5;
      const justificativa =
        data.justificativa ||
        "Mercado indefinido. IA recomenda n√£o operar neste momento.";

      if (acao === "COMPRAR") {
        acaoText.textContent = "COMPRAR";
        acaoText.className =
          "text-3xl md:text-4xl font-black mb-2 text-emerald-400";
      } else if (acao === "VENDER") {
        acaoText.textContent = "VENDER";
        acaoText.className =
          "text-3xl md:text-4xl font-black mb-2 text-rose-300";
      } else {
        acaoText.textContent = "N√ÉO OPERAR";
        acaoText.className =
          "text-3xl md:text-4xl font-black mb-2 text-amber-300";
      }

      confText.textContent = "Confian√ßa: " + (conf * 100).toFixed(0) + "%";
      justificativaText.textContent = justificativa;

      resultadoCard.classList.remove("hidden");
      statusText.textContent = "An√°lise conclu√≠da.";
    } catch (err) {
      console.error("Erro no fetch:", err);
      statusText.textContent = "Erro ao analisar. Tente novamente.";
      alert("Erro ao conectar com o servidor de IA.");
    } finally {
      analisarBtn.disabled = false;
    }
  });
</script>
