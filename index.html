<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>An√°lise de Investimentos com IA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-50">
    <!-- TOPO -->
    <header class="border-b border-slate-800 bg-slate-950/80 backdrop-blur">
      <div
        class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3"
      >
        <div class="flex items-center gap-2">
          <span class="text-xl">üìä</span>
          <div>
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold tracking-tight">
                ANALISADOR IA M1
              </span>
              <span
                class="px-2 py-0.5 rounded-full text-[10px] font-medium bg-emerald-500/10 text-emerald-300 border border-emerald-500/40"
              >
                BETA
              </span>
            </div>
            <p class="text-[11px] text-slate-400">
              IA + gerenciamento de risco para opera√ß√µes r√°pidas.
            </p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <span
            id="api-status"
            class="px-3 py-1 rounded-full text-[11px] font-medium border border-emerald-500/60 bg-emerald-500/10 text-emerald-200 flex items-center gap-1"
          >
            <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            API Online
          </span>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
      <!-- GRID PRINCIPAL -->
      <section
        class="grid gap-6 md:grid-cols-[minmax(0,1.7fr)_minmax(0,1.1fr)] items-start"
      >
        <!-- COLUNA ESQUERDA -->
        <section class="space-y-4">
          <!-- CARD PRINCIPAL -->
          <div
            class="bg-gradient-to-b from-violet-700/80 via-violet-900/80 to-slate-950 rounded-3xl p-5 md:p-6 shadow-[0_0_40px_rgba(0,0,0,0.8)] border border-violet-500/40"
          >
            <div class="flex items-center justify-between gap-3 mb-4">
              <div>
                <h2 class="text-sm md:text-base font-semibold text-slate-50">
                  An√°lise de Investimentos
                  <span id="timeframe-label" class="text-xs text-violet-200">
                    (M1)
                  </span>
                </h2>
                <p class="text-[11px] md:text-xs text-violet-100/90">
                  Tire um print do gr√°fico, envie aqui e a IA devolve a leitura
                  do cen√°rio.
                </p>
              </div>
              <span
                id="status-text"
                class="text-[11px] text-slate-200 md:ml-auto"
              >
                Aguardando imagem...
              </span>
            </div>

            <!-- PREVIEW -->
            <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3 mb-4">
              <div
                id="preview-container"
                class="rounded-xl overflow-hidden border border-slate-800 bg-slate-900/80 h-48 md:h-56 flex items-center justify-center"
              >
                <p
                  id="preview-placeholder"
                  class="text-xs text-slate-500 text-center px-4"
                >
                  Nenhuma imagem selecionada.<br />
                  Clique em
                  <span class="font-semibold text-slate-300">Escolher imagem</span>
                  ou cole um print do gr√°fico aqui.
                </p>
                <img
                  id="preview-image"
                  src=""
                  alt="Preview do gr√°fico"
                  class="hidden w-full h-full object-cover"
                />
              </div>
            </div>

            <!-- CONTROLES -->
            <div class="flex flex-col md:flex-row items-center gap-3">
              <button
                id="select-image-btn"
                type="button"
                class="w-full md:w-auto inline-flex items-center justify-center gap-2 rounded-full bg-slate-900/90 border border-slate-700 px-4 py-2.5 text-xs md:text-sm font-medium text-slate-100 hover:bg-slate-800 transition"
              >
                <span>Escolher imagem</span>
                <span class="text-slate-400 text-xs">(PNG / JPG)</span>
              </button>
              <input
                id="file-input"
                type="file"
                accept="image/*"
                class="hidden"
              />

              <button
                id="analisar-btn"
                type="button"
                class="w-full md:w-auto inline-flex items-center justify-center gap-2 rounded-full bg-violet-500 px-5 py-2.5 text-xs md:text-sm font-semibold text-white shadow-lg shadow-violet-500/40 hover:bg-violet-400 transition"
              >
                <span>Analizar gr√°fico</span>
              </button>

              <span
                class="text-[10px] text-violet-100/80 md:ml-auto md:text-right"
              >
                Dica: use prints limpos, sem muitos indicadores.
              </span>
            </div>
          </div>

          <!-- CARD PERFIL + TIMEFRAME -->
          <div
            class="bg-slate-900/80 border border-slate-800 rounded-3xl p-4 md:p-5 space-y-4"
          >
            <div class="flex flex-col md:flex-row md:items-start gap-4">
              <div class="flex-1">
                <h3 class="text-sm font-semibold text-slate-100 mb-1">
                  Perfil de risco da IA
                </h3>
                <p class="text-[11px] text-slate-400 mb-3">
                  Define quanta confian√ßa m√≠nima a IA precisa para liberar uma
                  entrada.
                </p>

                <div class="flex flex-wrap gap-2 mb-1">
                  <button
                    data-risk="conservador"
                    class="risk-btn px-3 py-2 rounded-full text-xs font-medium border border-emerald-500/60 bg-emerald-500/10 text-emerald-200"
                  >
                    Conservador (75%+)
                  </button>
                  <button
                    data-risk="moderado"
                    class="risk-btn px-3 py-2 rounded-full text-xs font-medium border border-slate-600 bg-slate-900 text-slate-200"
                  >
                    Moderado (60%+)
                  </button>
                  <button
                    data-risk="agressivo"
                    class="risk-btn px-3 py-2 rounded-full text-xs font-medium border border-slate-600 bg-slate-900 text-slate-200"
                  >
                    Agressivo (50%+)
                  </button>
                </div>

                <p class="text-[11px] text-slate-400">
                  <span class="font-semibold text-slate-200">Regra:</span>
                  se a confian√ßa vier abaixo do m√≠nimo do perfil, o app for√ßa
                  <span class="font-semibold text-amber-300">N√ÉO OPERAR</span>.
                </p>
              </div>

              <div class="w-px bg-slate-800 hidden md:block"></div>

              <div class="flex-1">
                <h3 class="text-sm font-semibold text-slate-100 mb-1">
                  Timeframe do gr√°fico
                </h3>
                <p class="text-[11px] text-slate-400 mb-3">
                  Informe em qual tempo o gr√°fico foi capturado para ajudar a IA
                  a ajustar a leitura.
                </p>
                <div class="flex flex-wrap gap-2">
                  <button
                    data-timeframe="M1"
                    class="timeframe-btn px-3 py-2 rounded-full text-xs font-medium border border-violet-500/70 bg-violet-500/15 text-violet-100"
                  >
                    M1
                  </button>
                  <button
                    data-timeframe="M5"
                    class="timeframe-btn px-3 py-2 rounded-full text-xs font-medium border border-slate-600 bg-slate-900 text-slate-200"
                  >
                    M5
                  </button>
                  <button
                    data-timeframe="M15"
                    class="timeframe-btn px-3 py-2 rounded-full text-xs font-medium border border-slate-600 bg-slate-900 text-slate-200"
                  >
                    M15
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- CARD BANCA + PLANO -->
          <div
            class="bg-slate-900/80 border border-slate-800 rounded-3xl p-4 md:p-5 space-y-4"
          >
            <div class="grid gap-4 md:grid-cols-2">
              <!-- BANCA -->
              <div>
                <h3 class="text-sm font-semibold text-slate-100 mb-1">
                  Gerenciamento de banca
                </h3>
                <p class="text-[11px] text-slate-400 mb-3">
                  Informe a banca e o risco por opera√ß√£o. Isso √© usado apenas
                  para simula√ß√£o educativa.
                </p>

                <label
                  class="block text-[11px] text-slate-300 mb-1"
                  for="banca-input"
                  >Banca (R$)</label
                >
                <input
                  id="banca-input"
                  type="number"
                  min="0"
                  step="0.01"
                  class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-violet-500"
                  placeholder="Ex: 200"
                />

                <p class="text-[11px] text-slate-400 mt-3 mb-1">
                  Risco por opera√ß√£o:
                </p>
                <div class="flex flex-wrap gap-2">
                  <button
                    type="button"
                    data-risk-value="0.5"
                    class="risk-value-btn px-3 py-1.5 rounded-full text-[11px] font-medium border border-slate-700 bg-slate-900 text-slate-200"
                  >
                    0,5%
                  </button>
                  <button
                    type="button"
                    data-risk-value="1"
                    class="risk-value-btn px-3 py-1.5 rounded-full text-[11px] font-medium border border-violet-500/70 bg-violet-500/10 text-violet-100"
                  >
                    1%
                  </button>
                  <button
                    type="button"
                    data-risk-value="2"
                    class="risk-value-btn px-3 py-1.5 rounded-full text-[11px] font-medium border border-slate-700 bg-slate-900 text-slate-200"
                  >
                    2%
                  </button>
                </div>

                <p
                  id="stake-text"
                  class="mt-3 text-[11px] text-slate-300 font-medium"
                >
                  Stake sugerida: ‚Äî
                </p>
              </div>

              <!-- PLANO DE SESS√ÉO -->
              <div>
                <h3 class="text-sm font-semibold text-slate-100 mb-1">
                  Plano da sess√£o
                </h3>
                <p class="text-[11px] text-slate-400 mb-3">
                  Defina quantas entradas pretende fazer na sess√£o. Isso n√£o
                  bloqueia nada, apenas te ajuda a respeitar o plano.
                </p>

                <label
                  class="block text-[11px] text-slate-300 mb-1"
                  for="meta-entradas-input"
                  >Meta de entradas executadas</label
                >
                <input
                  id="meta-entradas-input"
                  type="number"
                  min="1"
                  step="1"
                  class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-xs text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-1 focus:ring-violet-500"
                  placeholder="Ex: 10"
                />

                <button
                  id="salvar-plano-btn"
                  type="button"
                  class="mt-3 inline-flex items-center justify-center rounded-full bg-slate-800 px-4 py-2 text-[11px] font-medium text-slate-100 hover:bg-slate-700 transition"
                >
                  Salvar plano da sess√£o
                </button>

                <p
                  id="plano-resumo-text"
                  class="mt-2 text-[11px] text-slate-400"
                >
                  Nenhum plano definido ainda.
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- COLUNA DIREITA -->
        <section class="space-y-4">
          <!-- RESULTADO -->
          <div
            id="resultado-card"
            class="bg-gradient-to-r from-rose-900/85 via-rose-800/85 to-amber-800/80 border border-rose-500/50 rounded-3xl p-4 md:p-5 shadow-[0_0_40px_rgba(0,0,0,0.7)] hidden"
          >
            <div class="flex items-center justify-between mb-2">
              <span
                class="text-xs font-semibold text-slate-200 uppercase tracking-wide"
              >
                Resposta da IA
              </span>
              <span id="conf-text" class="text-[11px] text-slate-200">
                Confian√ßa: 0%
              </span>
            </div>

            <div
              class="text-3xl md:text-4xl font-black mb-1"
              id="acao-text"
            >
              N√ÉO OPERAR
            </div>

            <p
              class="text-[11px] md:text-sm text-slate-100 mb-2"
              id="justificativa-text"
            >
              A IA analisa tend√™ncia, topos e fundos, zonas de suporte e
              resist√™ncia para sugerir a melhor decis√£o.
            </p>

            <p class="text-[11px] text-slate-100/80" id="resumo-stake-text">
              Stake para esta an√°lise: ‚Äî
            </p>

            <p id="filtro-text" class="mt-2 text-[10px] text-slate-200/80"></p>
          </div>

          <!-- HIST√ìRICO -->
          <div
            class="bg-slate-900/80 border border-slate-800 rounded-3xl p-4 md:p-5"
          >
            <div class="flex items-center justify-between gap-3 mb-3">
              <h3 class="text-sm font-semibold text-slate-100">
                Hist√≥rico recente
              </h3>
              <span class="text-[11px] text-slate-400" id="hist-count">
                Nenhuma an√°lise ainda
              </span>
            </div>

            <div
              class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-950/60"
            >
              <table class="min-w-full text-[11px] md:text-xs">
                <thead class="bg-slate-900/80 text-slate-300">
                  <tr>
                    <th class="px-3 py-2 text-left font-medium">Hora</th>
                    <th class="px-3 py-2 text-left font-medium">A√ß√£o</th>
                    <th class="px-3 py-2 text-left font-medium">Confian√ßa</th>
                    <th class="px-3 py-2 text-left font-medium">Perfil</th>
                    <th class="px-3 py-2 text-left font-medium">TF</th>
                    <th class="px-3 py-2 text-left font-medium">Stake</th>
                    <th class="px-3 py-2 text-left font-medium">Executada?</th>
                  </tr>
                </thead>
                <tbody
                  id="hist-body"
                  class="divide-y divide-slate-800 text-slate-200"
                >
                  <!-- preenchido via JS -->
                </tbody>
              </table>
            </div>

            <p class="mt-2 text-[10px] text-slate-500">
              Esse hist√≥rico √© salvo localmente no seu navegador (localStorage).
            </p>
          </div>

          <!-- DASHBOARD SESS√ÉO -->
          <div
            class="bg-slate-900/80 border border-slate-800 rounded-3xl p-4 md:p-5 space-y-3"
          >
            <h3 class="text-sm font-semibold text-slate-100 mb-1">
              Dashboard da sess√£o
            </h3>
            <div class="grid grid-cols-2 gap-3 text-[11px] md:text-xs">
              <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3">
                <p class="text-slate-400 mb-1">Total de an√°lises</p>
                <p
                  id="sess-total-analises"
                  class="text-lg font-semibold text-slate-50"
                >
                  0
                </p>
              </div>

              <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3">
                <p class="text-slate-400 mb-1">Confian√ßa m√©dia</p>
                <p
                  id="sess-avg-conf"
                  class="text-lg font-semibold text-slate-50"
                >
                  0%
                </p>
              </div>

              <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3">
                <p class="text-slate-400 mb-1">Entradas executadas</p>
                <p
                  id="sess-executadas"
                  class="text-lg font-semibold text-slate-50"
                >
                  0
                </p>
                <p
                  id="sess-meta-text"
                  class="text-[10px] text-slate-400 mt-0.5"
                >
                  Meta: ‚Äî
                </p>
              </div>

              <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3">
                <p class="text-slate-400 mb-1">Distribui√ß√£o de sinais</p>
                <p
                  id="sess-dist-text"
                  class="text-[11px] text-slate-200 leading-relaxed"
                >
                  C: 0 ‚Ä¢ V: 0 ‚Ä¢ N: 0
                </p>
              </div>
            </div>
          </div>

          <!-- RESUMO DI√ÅRIO -->
          <div
            class="bg-slate-900/80 border border-slate-800 rounded-3xl p-4 md:p-5 space-y-2"
          >
            <h3 class="text-sm font-semibold text-slate-100 mb-1">
              Resumo de hoje
            </h3>
            <p class="text-[11px] text-slate-400 mb-2" id="dia-subtitle"></p>

            <div class="grid grid-cols-2 gap-3 text-[11px] md:text-xs">
              <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3">
                <p class="text-slate-400 mb-1">An√°lises de hoje</p>
                <p
                  id="dia-analises"
                  class="text-lg font-semibold text-slate-50"
                >
                  0
                </p>
              </div>

              <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3">
                <p class="text-slate-400 mb-1">Entradas executadas hoje</p>
                <p
                  id="dia-executadas"
                  class="text-lg font-semibold text-slate-50"
                >
                  0
                </p>
              </div>

              <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3">
                <p class="text-slate-400 mb-1">Confian√ßa m√©dia hoje</p>
                <p
                  id="dia-avg-conf"
                  class="text-lg font-semibold text-slate-50"
                >
                  0%
                </p>
              </div>

              <div class="bg-slate-950/70 rounded-2xl border border-slate-800 p-3">
                <p class="text-slate-400 mb-1">Distribui√ß√£o</p>
                <p
                  id="dia-dist-text"
                  class="text-[11px] text-slate-200 leading-relaxed"
                >
                  C: 0 ‚Ä¢ V: 0 ‚Ä¢ N: 0
                </p>
              </div>
            </div>
          </div>
        </section>
      </section>
    </main>

    <!-- SCRIPT -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ------------ CONSTANTES ------------
        const BACKEND_URL =
          "https://ia-analise-grafico.onrender.com/api/analisar";

        const MIN_CONF = {
          conservador: 75,
          moderado: 60,
          agressivo: 50,
        };

        const HISTORY_KEY = "ia_m1_history_v1";
        const PLAN_KEY = "ia_m1_plan_v1";

        // ------------ ELEMENTOS ------------
        const fileInput = document.getElementById("file-input");
        const selectImageBtn = document.getElementById("select-image-btn");
        const previewImage = document.getElementById("preview-image");
        const previewPlaceholder = document.getElementById(
          "preview-placeholder"
        );
        const analisarBtn = document.getElementById("analisar-btn");
        const statusText = document.getElementById("status-text");
        const timeframeLabel = document.getElementById("timeframe-label");
        const apiStatus = document.getElementById("api-status");

        const stakeText = document.getElementById("stake-text");
        const resumoStakeText = document.getElementById("resumo-stake-text");

        const resultadoCard = document.getElementById("resultado-card");
        const acaoText = document.getElementById("acao-text");
        const confText = document.getElementById("conf-text");
        const justificativaText =
          document.getElementById("justificativa-text");
        const filtroText = document.getElementById("filtro-text");

        const histBody = document.getElementById("hist-body");
        const histCount = document.getElementById("hist-count");

        const sessTotalAnalises = document.getElementById(
          "sess-total-analises"
        );
        const sessAvgConf = document.getElementById("sess-avg-conf");
        const sessExecutadas = document.getElementById("sess-executadas");
        const sessMetaText = document.getElementById("sess-meta-text");
        const sessDistText = document.getElementById("sess-dist-text");

        const diaSubtitle = document.getElementById("dia-subtitle");
        const diaAnalises = document.getElementById("dia-analises");
        const diaExecutadas = document.getElementById("dia-executadas");
        const diaAvgConf = document.getElementById("dia-avg-conf");
        const diaDistText = document.getElementById("dia-dist-text");

        const bancaInput = document.getElementById("banca-input");
        const riscoButtons = document.querySelectorAll(".risk-btn");
        const timeframeButtons =
          document.querySelectorAll(".timeframe-btn");
        const riskValueButtons =
          document.querySelectorAll(".risk-value-btn");

        const metaEntradasInput = document.getElementById(
          "meta-entradas-input"
        );
        const salvarPlanoBtn = document.getElementById("salvar-plano-btn");
        const planoResumoText =
          document.getElementById("plano-resumo-text");

        // ------------ ESTADO ------------
        let selectedFile = null;
        let currentRisk = "conservador";
        let currentTimeframe = "M1";

        let bancaAtual = 0;
        let riskPercent = 1; // 1%

        let history = [];
        let sessionPlan = { metaEntradas: null };

        // ------------ HELPERS ------------
        function formatCurrency(value) {
          if (!value && value !== 0) return "‚Äî";
          return (
            "R$ " +
            Number(value)
              .toFixed(2)
              .replace(".", ",")
          );
        }

        function loadHistory() {
          try {
            const raw = localStorage.getItem(HISTORY_KEY);
            if (raw) {
              const parsed = JSON.parse(raw);
              if (Array.isArray(parsed)) history = parsed;
            }
          } catch (e) {
            console.warn("Erro ao carregar hist√≥rico:", e);
          }
        }

        function saveHistory() {
          try {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
          } catch (e) {
            console.warn("Erro ao salvar hist√≥rico:", e);
          }
        }

        function loadPlan() {
          try {
            const raw = localStorage.getItem(PLAN_KEY);
            if (raw) {
              const parsed = JSON.parse(raw);
              if (parsed && typeof parsed === "object") {
                sessionPlan = {
                  metaEntradas: parsed.metaEntradas || null,
                };
              }
            }
          } catch (e) {
            console.warn("Erro ao carregar plano:", e);
          }
        }

        function savePlan() {
          try {
            localStorage.setItem(PLAN_KEY, JSON.stringify(sessionPlan));
          } catch (e) {
            console.warn("Erro ao salvar plano:", e);
          }
        }

        function updateStakePreview() {
          if (bancaAtual > 0 && riskPercent > 0) {
            const stake = (bancaAtual * riskPercent) / 100;
            stakeText.textContent =
              "Stake sugerida: " + formatCurrency(stake);
          } else {
            stakeText.textContent = "Stake sugerida: ‚Äî";
          }
        }

        function setImageFile(file) {
          if (!file) return;
          selectedFile = file;
          const reader = new FileReader();
          reader.onload = (ev) => {
            previewImage.src = ev.target.result;
            previewImage.classList.remove("hidden");
            previewPlaceholder.classList.add("hidden");
          };
          reader.readAsDataURL(file);
          statusText.textContent =
            "Imagem carregada. Pronto para analisar.";
        }

        function addToHistory(entry) {
          history.unshift(entry);
          if (history.length > 100) history.pop();
          saveHistory();
          renderHistory();
          updateDashboards();
        }

        function computeStats(list) {
          const stats = {
            total: list.length,
            comprar: 0,
            vender: 0,
            naoOperar: 0,
            avgConf: 0,
            executadas: 0,
          };

          if (!list.length) return stats;

          let confSum = 0;
          let confCount = 0;

          for (const item of list) {
            const ac = (item.acao || "").toUpperCase();
            if (ac === "COMPRAR") stats.comprar++;
            else if (ac === "VENDER") stats.vender++;
            else stats.naoOperar++;

            if (typeof item.confianca === "number") {
              confSum += item.confianca;
              confCount++;
            }

            if (item.executada) stats.executadas++;
          }

          stats.avgConf = confCount ? confSum / confCount : 0;
          return stats;
        }

        function renderHistory() {
          histBody.innerHTML = "";
          if (!history.length) {
            histCount.textContent = "Nenhuma an√°lise ainda";
            return;
          }

          histCount.textContent =
            history.length +
            (history.length === 1
              ? " an√°lise nesta sess√£o"
              : " an√°lises nesta sess√£o");

          history.forEach((item, index) => {
            const tr = document.createElement("tr");
            tr.className =
              "hover:bg-slate-900/70 transition-colors";

            const horaTd = document.createElement("td");
            horaTd.className = "px-3 py-2 whitespace-nowrap";
            horaTd.textContent = item.hora || "--:--:--";

            const acaoTd = document.createElement("td");
            acaoTd.className =
              "px-3 py-2 font-semibold uppercase";
            acaoTd.textContent = item.acao || "‚Äî";

            const confTd = document.createElement("td");
            confTd.className = "px-3 py-2";
            confTd.textContent =
              typeof item.confianca === "number"
                ? item.confianca + "%"
                : "‚Äî";

            const perfilTd = document.createElement("td");
            perfilTd.className = "px-3 py-2";
            perfilTd.textContent = item.perfilLabel || "‚Äî";

            const tfTd = document.createElement("td");
            tfTd.className = "px-3 py-2";
            tfTd.textContent = item.timeframe || "‚Äî";

            const stakeTd = document.createElement("td");
            stakeTd.className = "px-3 py-2";
            stakeTd.textContent = item.stake
              ? formatCurrency(item.stake)
              : "‚Äî";

            const execTd = document.createElement("td");
            execTd.className = "px-3 py-2";
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className =
              "px-2 py-1 rounded-full text-[10px] font-medium border transition";
            if (item.executada) {
              btn.textContent = "Executada";
              btn.classList.add(
                "bg-emerald-500/15",
                "border-emerald-500/60",
                "text-emerald-200"
              );
            } else {
              btn.textContent = "Marcar";
              btn.classList.add(
                "bg-slate-900",
                "border-slate-700",
                "text-slate-200"
              );
            }
            btn.addEventListener("click", () => {
              history[index].executada = !history[index].executada;
              saveHistory();
              renderHistory();
              updateDashboards();
            });
            execTd.appendChild(btn);

            tr.appendChild(horaTd);
            tr.appendChild(acaoTd);
            tr.appendChild(confTd);
            tr.appendChild(perfilTd);
            tr.appendChild(tfTd);
            tr.appendChild(stakeTd);
            tr.appendChild(execTd);

            histBody.appendChild(tr);
          });
        }

        function updateDashboards() {
          // Sess√£o completa
          const sessStats = computeStats(history);
          sessTotalAnalises.textContent = sessStats.total;
          sessAvgConf.textContent =
            sessStats.avgConf.toFixed(1) + "%";
          sessExecutadas.textContent = sessStats.executadas;

          if (sessionPlan.metaEntradas) {
            const rest =
              sessionPlan.metaEntradas - sessStats.executadas;
            sessMetaText.textContent =
              "Meta: " +
              sessionPlan.metaEntradas +
              " ‚Ä¢ Restam: " +
              (rest > 0 ? rest : 0);
            planoResumoText.textContent =
              "Plano ativo: " +
              sessionPlan.metaEntradas +
              " entradas. J√° executadas: " +
              sessStats.executadas +
              ".";
          } else {
            sessMetaText.textContent = "Meta: ‚Äî";
            planoResumoText.textContent =
              "Nenhum plano definido ainda.";
          }

          sessDistText.textContent =
            "C: " +
            sessStats.comprar +
            " ‚Ä¢ V: " +
            sessStats.vender +
            " ‚Ä¢ N: " +
            sessStats.naoOperar;

          // Resumo di√°rio (hoje)
          const todayStr = new Date().toLocaleDateString("pt-BR");
          const todayList = history.filter((item) => {
            if (!item.timestamp) return false;
            try {
              return (
                new Date(item.timestamp).toLocaleDateString(
                  "pt-BR"
                ) === todayStr
              );
            } catch {
              return false;
            }
          });

          diaSubtitle.textContent = "Hoje: " + todayStr;

          const diaStats = computeStats(todayList);
          diaAnalises.textContent = diaStats.total;
          diaExecutadas.textContent = diaStats.executadas;
          diaAvgConf.textContent =
            diaStats.avgConf.toFixed(1) + "%";
          diaDistText.textContent =
            "C: " +
            diaStats.comprar +
            " ‚Ä¢ V: " +
            diaStats.vender +
            " ‚Ä¢ N: " +
            diaStats.naoOperar;
        }

        async function checkApiStatus() {
          try {
            const baseUrl = BACKEND_URL.replace(
              "/api/analisar",
              "/"
            );
            const res = await fetch(baseUrl);
            if (!res.ok) throw new Error("HTTP " + res.status);
            apiStatus.classList.remove(
              "border-rose-500/70",
              "bg-rose-500/10",
              "text-rose-200"
            );
            apiStatus.classList.add(
              "border-emerald-500/60",
              "bg-emerald-500/10",
              "text-emerald-200"
            );
            apiStatus.innerHTML =
              '<span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span> API Online';
          } catch (e) {
            apiStatus.classList.remove(
              "border-emerald-500/60",
              "bg-emerald-500/10",
              "text-emerald-200"
            );
            apiStatus.classList.add(
              "border-rose-500/70",
              "bg-rose-500/10",
              "text-rose-200"
            );
            apiStatus.innerHTML =
              '<span class="w-2 h-2 rounded-full bg-rose-400 animate-pulse"></span> API Offline';
          }
        }

        // ------------ EVENTOS DE UI ------------
        selectImageBtn.addEventListener("click", () => {
          fileInput.click();
        });

        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          setImageFile(file);
        });

        // Colar imagem (print copiado)
        window.addEventListener("paste", (event) => {
          const items = event.clipboardData?.items;
          if (!items) return;
          for (const item of items) {
            if (item.type.startsWith("image/")) {
              const file = item.getAsFile();
              setImageFile(file);
              break;
            }
          }
        });

        // Risco (perfil)
        riscoButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const value = btn.dataset.risk;
            currentRisk = value;
            riscoButtons.forEach((b) =>
              b.classList.remove(
                "border-emerald-500/60",
                "bg-emerald-500/10",
                "text-emerald-200"
              )
            );
            if (value === "conservador") {
              btn.classList.add(
                "border-emerald-500/60",
                "bg-emerald-500/10",
                "text-emerald-200"
              );
            } else {
              btn.classList.add(
                "border-violet-500/70",
                "bg-violet-500/10",
                "text-violet-100"
              );
            }
          });
        });

        // Timeframe
        timeframeButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            currentTimeframe = btn.dataset.timeframe || "M1";
            timeframeLabel.textContent = "(" + currentTimeframe + ")";
            timeframeButtons.forEach((b) =>
              b.classList.remove(
                "border-violet-500/70",
                "bg-violet-500/15",
                "text-violet-100"
              )
            );
            btn.classList.add(
              "border-violet-500/70",
              "bg-violet-500/15",
              "text-violet-100"
            );
          });
        });

        // Banca
        bancaInput.addEventListener("input", () => {
          const val = parseFloat(bancaInput.value.replace(",", "."));
          bancaAtual = isNaN(val) ? 0 : val;
          updateStakePreview();
        });

        // Risco por opera√ß√£o (0.5 / 1 / 2 %)
        riskValueButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            riskValueButtons.forEach((b) =>
              b.classList.remove(
                "border-violet-500/70",
                "bg-violet-500/10",
                "text-violet-100"
              )
            );
            btn.classList.add(
              "border-violet-500/70",
              "bg-violet-500/10",
              "text-violet-100"
            );
            const val = parseFloat(btn.dataset.riskValue);
            riskPercent = isNaN(val) ? 0 : val;
            updateStakePreview();
          });
        });

        // Plano da sess√£o
        salvarPlanoBtn.addEventListener("click", () => {
          const val = parseInt(metaEntradasInput.value, 10);
          if (!val || val <= 0) {
            sessionPlan.metaEntradas = null;
          } else {
            sessionPlan.metaEntradas = val;
          }
          savePlan();
          updateDashboards();
        });

        // Analisar
        analisarBtn.addEventListener("click", async () => {
          if (!selectedFile) {
            alert("Selecione uma imagem de gr√°fico primeiro.");
            return;
          }

          analisarBtn.disabled = true;
          analisarBtn.classList.add("opacity-60", "cursor-not-allowed");
          statusText.textContent = "Enviando imagem para a IA...";
          resultadoCard.classList.add("hidden");

          try {
            const formData = new FormData();
formData.append("image", selectedFile); // ‚úÖ nome certo

// se voc√™ estiver adicionando mais coisas, pode manter:
formData.append("risk_profile", perfilDescricao);
formData.append("timeframe", currentTimeframe);
formData.append("banca", String(bancaAtual || ""));
formData.append("risco_percentual", String(riskPercent || ""));


            // Envia o perfil como texto mais completo (a API s√≥ v√™ uma string)
            const perfilDescricao =
              currentRisk.toUpperCase() +
              " - gr√°fico " +
              currentTimeframe +
              (bancaAtual
                ? " - banca ~R$" + bancaAtual.toFixed(2)
                : "") +
              (riskPercent
                ? " - risco " + riskPercent + "% por opera√ß√£o"
                : "");
            formData.append("risk_profile", perfilDescricao);
            formData.append("timeframe", currentTimeframe);
            formData.append("banca", String(bancaAtual || ""));
            formData.append(
              "risco_percentual",
              String(riskPercent || "")
            );

            const res = await fetch(BACKEND_URL, {
              method: "POST",
              body: formData,
            });

            if (!res.ok) {
              throw new Error("HTTP " + res.status);
            }

            const data = await res.json();

            let acao = (data.acao || "NAO_OPERAR").toUpperCase();
            let rawConf = data.confianca ?? 0;
            let conf =
              rawConf <= 1 ? Math.round(rawConf * 100) : Math.round(rawConf);
            if (conf < 0) conf = 0;
            if (conf > 100) conf = 100;

            const justificativa =
              data.justificativa ||
              "A IA n√£o retornou justificativa detalhada.";

            // Aplica filtro de perfil (for√ßa NAO_OPERAR se confian√ßa < m√≠nima)
            const minConf = MIN_CONF[currentRisk] ?? 75;
            let acaoFinal = acao;
            let filtroMensagem = "";

            if (conf < minConf && acao !== "NAO_OPERAR") {
              acaoFinal = "NAO_OPERAR";
              filtroMensagem =
                "Perfil " +
                currentRisk.toUpperCase() +
                " ativo: confian√ßa " +
                conf +
                "% abaixo do m√≠nimo (" +
                minConf +
                "%). A√ß√£o for√ßada para N√ÉO OPERAR.";
            } else {
              filtroMensagem =
                "A√ß√£o liberada com base no perfil " +
                currentRisk.toUpperCase() +
                " e confian√ßa de " +
                conf +
                "%.";
            }

            // Calcula stake da opera√ß√£o
            let stake = null;
            if (bancaAtual > 0 && riskPercent > 0) {
              stake = (bancaAtual * riskPercent) / 100;
            }

            // Atualiza UI de resultado
            confText.textContent = "Confian√ßa: " + conf + "%";
            acaoText.textContent = acaoFinal.replace("_", " ");
            justificativaText.textContent = justificativa;
            filtroText.textContent = filtroMensagem;
            resumoStakeText.textContent =
              "Stake para esta an√°lise: " +
              (stake ? formatCurrency(stake) : "‚Äî");
            resultadoCard.classList.remove("hidden");

            statusText.textContent = "An√°lise conclu√≠da.";

            // Monta item de hist√≥rico
            const now = new Date();
            const entry = {
              timestamp: now.toISOString(),
              hora: now.toLocaleTimeString("pt-BR", {
                hour12: false,
              }),
              acao: acaoFinal,
              confianca: conf,
              perfil: currentRisk,
              perfilLabel:
                currentRisk === "conservador"
                  ? "Conservador"
                  : currentRisk === "moderado"
                  ? "Moderado"
                  : "Agressivo",
              timeframe: currentTimeframe,
              stake: stake,
              executada: false,
            };

            addToHistory(entry);
          } catch (err) {
            console.error("Erro no fetch:", err);
            statusText.textContent =
              "Erro ao analisar. Tente novamente.";
            alert("Erro ao conectar com o servidor de IA.");
          } finally {
            analisarBtn.disabled = false;
            analisarBtn.classList.remove(
              "opacity-60",
              "cursor-not-allowed"
            );
          }
        });

        // ------------ INICIALIZA√á√ÉO ------------
        loadHistory();
        loadPlan();
        if (sessionPlan.metaEntradas) {
          metaEntradasInput.value = sessionPlan.metaEntradas;
        }
        updateStakePreview();
        renderHistory();
        updateDashboards();
        checkApiStatus();
      });
    </script>
  </body>
</html>
